#!/bin/bash

error() {
	echo "ERROR: $1" | tee -a config.log
	exit 1
}

rm -f config.log


{
	echo "# netmap configure log $(date)"
	echo "# Configured with:"
	printf " '%s'" "$0" "$@"
	echo
	echo "#"
} > config.log

exec 2>> config.log
set -x

ksrc=
src=
# get ksrc and src before anything else
for opt do
	optarg=${opt#*=}
	case "$opt" in
	--kernel-dir=*) ksrc="$optarg"
	;;
	--kernel-sources=*) src="$optarg"
	;;
	esac
done

[ -n "$ksrc" ] || {
	# user did not provide a kernel dir,
	# we try to find one by ourselves
	ksrc="/lib/modules/$(uname -r)/build"
}

[ -n "$src" ] || {
	[ -d "$ksrc/source" ] && src="$ksrc/source"
	[ -n "$src" ] || src=$ksrc
}

[ -d "$ksrc" ] || error "Cannot find kernel directory"
[ -f "$ksrc/.config" ] || error "kernel not configured"
version_hdr="$ksrc/include/linux/version.h"
[ -f "$version_hdr" ] || version_hdr="$ksrc/include/generated/uapi/linux/version.h"
[ -f "$version_hdr" ] || error "version.h is missing"
lin_ver=$(awk '/LINUX_VERSION_CODE/ { printf "%03x%02x", $3/256, $3%256}' "$version_hdr")
[ -d "$src" ] || error "Cannot find kernel sources"
[ -n "$(find "$src" -name '*.c' -print -quit)" ] || error "'$src' does not appear to contain full kernel sources"

# create Makefile
sed \
	-e "s|@KSRC@|$ksrc|g" \
	-e "s|@SRC@|$src|g" \
	-e "s|@LIN_VER@|$lin_ver|g" \
	Makefile.in > Makefile


# report
echo "kernel directory            $ksrc"
echo "kernel sources              $src"
echo "linux version               $lin_ver"
